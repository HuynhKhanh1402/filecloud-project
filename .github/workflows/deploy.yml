name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy project files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "."
          target: ${{ secrets.DEPLOY_PATH }}
          rm: false

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e

            cd ${{ secrets.DEPLOY_PATH }}

            echo "Current directory:"
            pwd

            echo "Checking docker compose..."
            if ! command -v docker compose >/dev/null 2>&1; then
              echo "docker compose not found"
              exit 1
            fi

            echo "Checking .env file..."
            if [ ! -f .env ]; then
              echo ".env NOT FOUND - aborting to avoid breaking production"
              exit 1
            fi

            echo "Stopping old containers..."
            docker compose down --remove-orphans || true

            echo "Starting containers..."
            docker compose up -d --build --remove-orphans

            echo "Containers status:"
            docker compose ps

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e

            echo "Checking backend..."
            BACKEND_OK=false
            for i in {1..10}; do
              if curl -fsS http://localhost:3000/api/health; then
                echo "Backend OK"
                BACKEND_OK=true
                break
              fi
              echo "Waiting backend... ($i/10)"
              sleep 5
            done

            if [ "$BACKEND_OK" != "true" ]; then
              echo "Backend health check FAILED"
              exit 1
            fi

            echo "Checking frontend..."
            FRONTEND_OK=false
            for i in {1..10}; do
              if curl -fsS http://localhost:5173; then
                echo "Frontend OK"
                FRONTEND_OK=true
                break
              fi
              echo "Waiting frontend... ($i/10)"
              sleep 5
            done

            if [ "$FRONTEND_OK" != "true" ]; then
              echo "Frontend health check FAILED"
              exit 1
            fi

            echo "Deployment successful"